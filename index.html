<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Photo Display App</title>
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">

  <style>
    html, body {
      margin:0; padding:0; width:100%; height:100%;
      overflow:hidden;
      background:#111;
      color:white;
      font-family:"Segoe UI", sans-serif;
      display:flex; flex-direction:column; align-items:center;
    }
    h1 { margin-top:10px; font-weight:600; font-size:1.8rem; letter-spacing:0.5px; opacity:0.9;}
    #qrcode { margin-top:10px; transform:scale(1.4);}
    #waitingText { margin-top:25px; font-size:1.4rem; opacity:0.7; transition:opacity .4s;}
    img {
      max-width:100%; max-height:calc(100% - 230px);
      object-fit:contain;
      margin-top:15px;
      opacity:0;
      transition: opacity 0.6s ease;
    }

    /* Upload Modal */
    #uploadModal {
      position: fixed; inset:0;
      background: rgba(0,0,0,0.85);
      display:none;
      justify-content:center; align-items:center;
      flex-direction:column;
      color:white; padding:20px;
      backdrop-filter: blur(8px);
      z-index:1000;
    }
    #uploadModal input, #uploadModal button {
      font-size:18px; padding:12px 16px; border-radius:8px;
      margin-top:8px;
    }
  </style>
</head>
<body>

<h1>üì∏ ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</h1>

<div id="qrcode"></div>
<div id="waitingText">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‚Ä¶</div>
<img id="displayImage">

<!-- Upload Modal -->
<div id="uploadModal">
  <h2>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h2>
  <input type="file" accept="image/*" id="fileInput" capture="environment">
  <button onclick="closeUploadModal()">‡∏õ‡∏¥‡∏î</button>
</div>

<audio id="notifySound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, set, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
  authDomain: "suchartwork-1487382986748.firebaseapp.com",
  databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
  projectId: "suchartwork-1487382986748",
  storageBucket: "suchartwork-1487382986748.appspot.com",
  messagingSenderId: "353884592527",
  appId: "1:353884592527:web:cbb6bd2c20c6c986eb13fa"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);
const notify = document.getElementById("notifySound");

function generateSession(){ return Math.random().toString(36).substr(2,6);}
let sessionId = generateSession();

// ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
function showQR(){
  document.getElementById("qrcode").innerHTML="";
  new QRCode(document.getElementById("qrcode"), location.origin + location.pathname + "?session=" + sessionId);
}
showQR();

// ‡∏ü‡∏±‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
onValue(ref(db, "images/" + sessionId), (snapshot)=>{
  const data = snapshot.val();
  if(data && data.url){
    const img = document.getElementById("displayImage");
    img.src = data.url;
    img.style.opacity=1;
    document.getElementById("waitingText").style.opacity=0;
    notify.play();
    setTimeout(()=>{
      remove(ref(db,"images/"+sessionId));
      img.style.opacity=0;
      img.src="";
      document.getElementById("waitingText").style.opacity=0.7;
      sessionId = generateSession();
      showQR();
    },30000);
  }
});

// -------------------- Upload Modal --------------------
const params = new URLSearchParams(location.search);
const uploadSession = params.get("session");
if(uploadSession){ document.getElementById("uploadModal").style.display="flex"; }

async function resizeImage(file, maxWidth=800, maxHeight=800, quality=0.7){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      let w = img.width;
      let h = img.height;
      if(w>maxWidth || h>maxHeight){
        const scale = Math.min(maxWidth/w, maxHeight/h);
        w = w*scale;
        h = h*scale;
      }
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,w,h);
      canvas.toBlob((blob)=>resolve(blob),"image/jpeg",quality);
    };
    img.src = URL.createObjectURL(file);
  });
}

document.getElementById("fileInput").onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const dbRefImg = ref(db, "images/" + uploadSession);

  // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤
  const snap = await get(dbRefImg);
  if(snap.exists()){
    const oldUrl = snap.val().url;
    if(oldUrl){
      try{ 
        const oldRef = sRef(storage, oldUrl.split("https://firebasestorage.googleapis.com/v0/b/")[1].split("?")[0]);
        await deleteObject(oldRef);
      }catch{}
    }
  }

  // ‡∏¢‡πà‡∏≠‡∏†‡∏≤‡∏û
  const resizedBlob = await resizeImage(file);

  // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
  const newPath = "uploads/"+uploadSession+".jpg";
  const storageRef = sRef(storage,newPath);
  await uploadBytes(storageRef,resizedBlob);
  const url = await getDownloadURL(storageRef);
  await set(dbRefImg,{url});

  alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  closeUploadModal();
};

// ‡∏õ‡∏¥‡∏î modal
window.closeUploadModal = ()=>{ document.getElementById("uploadModal").style.display="none"; history.pushState({}, "", location.pathname);}
</script>
</body>
</html>
